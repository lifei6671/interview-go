# ES 的数据倾斜，如何解决？

## 一、什么是 Elasticsearch 数据倾斜？

ES 是“按 shard 分片”的分布式搜索引擎，每条数据通过 **routing hash → primary shard** 写入。

如果：

* 大部分数据集中在少数 shard 上
* 读写负载集中在某些 shard 上

就会出现 **数据倾斜 / 查询倾斜 / 写入倾斜**。

表现为：

* 部分 shard 变大（heap 占用暴涨）
* GC 压力高
* 搜索延迟飙升
* 写入阻塞、刷新频繁
* 节点负载不均匀

---

## 二、ES 数据倾斜的常见原因

面试官通常希望你能说出这几类：

### 1. 默认 routing 仅按 `_id` 做 hash，不均匀

某些 id 模式使 hash 分布不均。

### 2. 按“业务字段 routing”导致集中写入（最常见）

例如按 `user_id` routing，而一些大用户写量极高。

### 3. 时间序列导致“热分片（Hot Shard）”

写入只打到最新的一个分片上，例如：

* 日索引：当天索引写入量巨大
* rollover/ILM 不均匀导致某些 index size 过大

### 4. 数据天然不均匀

某些分类、地域、业务字段占比极大，导致索引结构偏斜。

### 5. 查询倾斜（搜索请求集中访问某些 shard）

典型如热词搜索、热点内容（热门新闻/商品）导致某些分片负载暴增。

---

## 三、如何判断数据倾斜？

### 1. 通过 Cat API 看 shard size

```
GET _cat/shards?v&s=store
```

如果某些 shard 明显大于平均值 → 数据倾斜。

### 2. 看各节点 heap、CPU、IO

```
GET _nodes/stats
```

热节点基本对应热 shard。

### 3. 查看写入热点

```
GET my-index/_stats/indexing
```

### 4. 查看请求热点

```
GET my-index/_stats/search
```

高级面试可继续说：

* 观察 segment merge 时间
* 观察 refresh 时间
* 观察 shard-level queue backlog

---

## 四、重头戏：ES 数据倾斜的解决方案（按业务类型）

下面是面试官最关心的部分。

### 解决方案一：增加索引的 primary shard 数量（最基础）

如果 shard 数过少，无法容纳足够的数据分布。

例如从 5 分片扩展到 10、15。

**适用：一般数据量大但分布均匀的场景。**

缺点：
索引无法动态扩容，只能重建索引（reindex）。

---

### 解决方案二：自定义 routing，使分布打散（高级必答）

业务常见方式：

* `routing = user_id % shard_count`
* `routing = hash(order_id + region_id)`
* `routing = hash(device_id + hour)`

目标是人工打散“热点 key”。

#### 示例优化：

原 routing：

```
routing = user_id
```

优化为：

```
routing = user_id % 32
```

这样大用户的数据不会集中打到一个分片。

非常多企业的 ES 数据倾斜问题都因 routing 不均匀导致。

---

### 解决方案三：使用 index alias + 多索引分流（推荐）

常见于“热点分类倾斜”。

例：根据业务类型创建多个索引：

* logs-app-0001
* logs-app-0002
* logs-app-0003

通过 alias 统一访问：

```
app-logs -> (logs-app-0001, logs-app-0002, logs-app-0003)
```

写入端根据 hash 选择索引，达到分流效果。

---

## 解决方案四：采用 Rollover + ILM，使每个 index 尺寸均匀（时序系统必备）

时间序列数据常常出现某一天写入量巨大。

解决：

* 每个 index 控制上限（e.g. 30GB）
* 超过阈值自动 rollover
* 让每天可能有多个 index，而不是固定一个

这样不会出现：

```
2025-01-01 一个索引 100GB
2025-01-02 一个索引 5GB
```

显著减少热分片。

---

## 解决方案五：使用“时间 + hash”分桶（主流 TSDB 策略）

例如按“天 + hash”分：

原来：

```
logs-20250101
```

优化：

```
logs-20250101-000
logs-20250101-001
logs-20250101-002
logs-20250101-003
```

写入端以：

```
target_index = "logs-" + day + "-" + (hash(device_id) % 4)
```

这样时间序列系统的热分片能完全被打散。

ES 官方也推荐这种做法。

---

### 解决方案六：对热点查询做缓存或路由调整

查询倾斜通常来自热门内容：

优化策略：

* 使用 `search_after` 与 scroll 减少深分页压力
* 开启 request cache
* 把热门内容缓存到 Redis
* 把热点查询复制一份到专用索引（冷索引+热索引分离）

---

### 解决方案七：使用 data tier（hot-warm-cold）避免热节点压力过大

三层拓扑：

* Hot：最新数据，写密集
* Warm：少查询，主要范围扫描
* Cold：历史数据，几乎不动

数据分层后：

* 热 shard 更小
* 热节点压力更可控
* 大 shard 移动到 warm/cold 减少热点问题

---

### 解决方案八：Reindex 重建索引，调整 mapping/shard 模型

如果已经严重倾斜：

* 创建新索引
* 调整 shard 数
* 调整体 hash 策略
* 通过 reindex-from-remote 或批处理迁移数据

---

## 五、总结

Elasticsearch 数据倾斜主要来自 routing 不均、时间序列热写入导致的 hot shard、或查询倾斜。

  解决方案分为三类：
  - 1）**索引层面**：调整 primary shard 数量、使用 alias 分流、多索引策略、rollover+ILM、time+hash 分桶。
  - 2）**路由层面**：自定义 routing、避免热点 key 导致集中写入。
  - 3）**查询层面**：缓存热点查询、冷热分层架构、减少深分页。

根本思想是打散写入、均匀 shard 尺寸、减少某个 shard 的独占压力。

